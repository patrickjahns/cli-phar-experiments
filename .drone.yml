workspace:
  base: /drone
  path: src

pipeline:
  cache-restore:
    image: plugins/s3-cache:1
    pull: true
    secrets: [ cache_s3_endpoint, cache_s3_access_key, cache_s3_secret_key ]
    restore: true
    when:
      local: false
      event: [tag, push, pull_request]

  composer:
    image: owncloudci/php:7.1
    pull: true
    environment:
      - COMPOSER_HOME=/drone/src/.composer
    commands:
      - composer install

  cache-rebuild:
    image: plugins/s3-cache:1
    pull: true
    secrets: [ cache_s3_endpoint, cache_s3_access_key, cache_s3_secret_key ]
    rebuild: true
    mount:
      - .composer
    when:
      local: false
      event: [push]
      branch: master

  cache-flush:
    image: plugins/s3-cache:1
    pull: true
    secrets: [ cache_s3_endpoint, cache_s3_access_key, cache_s3_secret_key ]
    flush: true
    flush_age: 14
    when:
      local: false
      event: [push]
      branch: master

#  code-style:
#    image: owncloudci/php:7.1
#    pull: true
#    commands:
#      - php vendor/bin/php-cs-fixer fix --dry-run --diff

  static-code-analyzer-71:
    image: owncloudci/php:7.1
    pull: true
    group: static-code-analyzer
    commands:
      - php vendor/bin/phpstan analyse -c phpstan.neon -l 4 bin config src
      - php ./vendor/bin/psalm
      - php vendor/bin/phan

  static-code-analyzer-72:
    image: owncloudci/php:7.2
    pull: true
    group: static-code-analyzer
    commands:
      - php vendor/bin/phpstan analyse -c phpstan.neon -l 4 bin config src
      - php ./vendor/bin/psalm
      - php vendor/bin/phan

  phpunit:
    image: owncloudci/php:7.1
    pull: true
    commands:
      - php vendor/bin/phpunit

  build-phar:
    image: patrickjahns/box
    pull: true
    commands:
      - box compile --config box.json
    when:
      event: [push, pull_request]

  verify-build:
    image: patrickjahns/box
    pull: true
    commands:
      - box verify ./build/oct.phar

  acceptance-test:
    image: php:7.1-cli-alpine
    pull: true
    commands:
      - php vendor/bin/behat



